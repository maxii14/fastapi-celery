# Fastapi + Celery
Сервис для генерации серийных номеров с использованием Fastapi и Celery.
В очередь можно добавлять любые другие задачи, создав новые endpoint.

<!--Установка-->
### Установка компонентов (Windows)
1. Установите зависимости из файла ```requirements.txt```
2. По [ссылке](https://github.com/tporadowski/redis/releases) скачайте Redis-x64-5.0.14.1.zip
3. Перейдите в файл .env и настройте параметры для получения доступа к БД, токену и celery. В качестве broker и backend может выступать redis

<!--Запуск-->
### Запуск
1. Запустите ```redis-server.exe```, а затем ```redis-cli.exe```. В ```redis-cli.exe``` можно ввести <u>keys *</u> для проверки работоспособности. __Эти две утилиты должны работать на фоне в качестве брокера и background celery__
2. В терминале запустите celery: ```celery -A services:celery worker --loglevel=INFO --pool=solo```. Если запуск происходит на Linux, то флаг ```--pool``` можно убрать
3. В терминале запустите сервер uvicorn для fastapi: ```uvicorn main:app```. Если нужно запустить на определённом порте, то добавьте флаг ```--port```
4. Также в терминале можно запустить flower: ```celery -A services:celery flower```. После запуска на порте _5555_ будет доступен удобный веб-интерфейс, в котором можно отслеживать задачи

<!--API-->
### API
1. Для генерации серийных номеров нужно сделать POST запрос на endpoint ```/generate_sn```. В headers передайте заголовок _Content-Type:application/json_ и в теле запроса передайте JSON объект вида\
{\
    "code_model": "0111",\
    "number": 1,\
    "count": 10\
}\
где code_model - код модели, number - номер, с которого начинается генерация и count - количество серийников.\
В ответ возвращается id созданной задачи
2. Для получения статуса задачи по её id нужно сделать GET запрос на endpoint ```/tasks/{id}```, вместо id подставив полученный ранее id задачи. Вернётся JSON объект, в котором будет указан id задачи и её состояние

<!--Архитектура-->
### Архитектура
1. Для подключения к БД используется sqlalchemy. Создание модели БД, engine, metadata и функция для добавления задачи в БД находятся в файле ```models.py```
2. Описание endpoint находится в файле ```router.py```, который подключается в ```main.py```
3. Все функции, которые используются при выполнении задач, и сами задачи находятся в файле ```services.py```. Celery-задачи помечены аннотациями _celery.task_ или _shared_task_. Создание объекта celery и подключение к токену находятся в этом же файле
4. Для доступа к переменным окружения из .env файла импортируется объект settings из файла ```config.py```. В классе Settings достаются значения из .env и из этого же класса получаем URL для подключения к БД
